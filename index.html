<!DOCTYPE html>
<html>
<head>
  <title>Smart Ambulance</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>üöë Smart Ambulance Panel</h2>

<p id="liveLocation">Getting Location...</p>

<h3>Nearest Hospitals</h3>
<div id="hospitalList"></div>

<button onclick="emergency()" style="background:red;color:white;padding:10px;">
üö® EMERGENCY
</button>

<script>
const { createClient } = supabase;

const client = createClient(
  "https://inlkqessbewmxmtfvzfe.supabase.co",
  "YOUR_ANON_KEY"
);

let ambulanceId = "A1";
let currentLat = 0;
let currentLng = 0;
let selectedHospital = null;

/* 1Ô∏è‚É£ Get Real GPS Location */
navigator.geolocation.watchPosition(async (position) => {

  currentLat = position.coords.latitude;
  currentLng = position.coords.longitude;

  document.getElementById("liveLocation").innerText =
    "Live Location: " + currentLat + ", " + currentLng;

  /* Update location to database */
  await client.from("ambulances").update({
    latitude: currentLat,
    longitude: currentLng,
    status: "Active",
    selected_hospital: selectedHospital
  }).eq("id", ambulanceId);

  loadNearestHospitals();

});

/* 2Ô∏è‚É£ Load Nearest Hospitals */
async function loadNearestHospitals() {

  const { data } = await client.from("hospitals").select("*");

  let list = document.getElementById("hospitalList");
  list.innerHTML = "";

  data.forEach(h => {

    let distance = getDistance(
      currentLat, currentLng,
      h.latitude, h.longitude
    );

    let btn = document.createElement("button");
    btn.innerText = h.name + " (" + distance.toFixed(2) + " km)";
    btn.onclick = () => selectHospital(h.id);

    list.appendChild(btn);
    list.appendChild(document.createElement("br"));

  });
}

/* Distance Formula */
function getDistance(lat1, lon1, lat2, lon2) {

  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c;
}

/* 3Ô∏è‚É£ Select Hospital */
async function selectHospital(id) {

  selectedHospital = id;

  await client.from("ambulances").update({
    selected_hospital: id,
    status: "On The Way"
  }).eq("id", ambulanceId);

  alert("Hospital Selected!");
}

/* 4Ô∏è‚É£ Emergency Button */
async function emergency() {

  await client.from("ambulances").update({
    status: "EMERGENCY"
  }).eq("id", ambulanceId);

  alert("Emergency Sent to Police & Hospital!");
}

</script>
</body>
</html>

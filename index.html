<!DOCTYPE html>
<html>
<head>
  <title>Ambulance Device</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial; background:#f4f6f9; }
    .box {
      max-width:420px; margin:40px auto; background:white;
      padding:20px; border-radius:10px;
      box-shadow:0 4px 10px rgba(0,0,0,.2);
      text-align:center;
    }
    select,input,button {
      width:100%; padding:10px; margin-top:10px; font-size:16px;
    }
    .emergency { background:red; color:white; font-weight:bold; }
    .cancel { background:#444; color:white; }
    .hint { font-size:13px; color:#555; margin-top:6px; }
  </style>
</head>
<body>

<div class="box">
  <h2>üöë Ambulance Device</h2>

  <select id="hospitalList">
    <option value="">üè• Select nearest hospital</option>
  </select>

  <div class="hint">
    Hospitals are auto-sorted by nearest distance
  </div>

  <input id="location" placeholder="Live GPS location" readonly>

  <button onclick="startTracking()">‚ñ∂ START TRACKING</button>
  <button onclick="stopTracking()">‚õî STOP TRACKING</button>

  <button class="emergency" onclick="sendEmergency()">üö® EMERGENCY ALERT</button>
  <button class="cancel" onclick="cancelEmergency()">‚ùå CANCEL ALERT</button>

  <p id="msg"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = supabase.createClient(
  "https://inlkqessbewmxmtfvzfe.supabase.co",
  "YOUR_ANON_KEY"
);

let watchId=null;
let hospitals=[];

/* Distance calc (for sorting only) */
function distanceKm(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* Load hospitals (Overpass API ‚Äì Nellore) */
async function loadHospitals(){
  const q=`[out:json];
    node["amenity"="hospital"](14.399,79.941,14.470,80.021);
    out;`;
  const r=await fetch("https://overpass-api.de/api/interpreter",
    {method:"POST",body:q});
  const j=await r.json();
  hospitals=j.elements
    .filter(h=>h.tags&&h.tags.name)
    .map(h=>({name:h.tags.name,lat:h.lat,lon:h.lon}));
}
loadHospitals();

/* Update dropdown order */
function updateHospitalList(lat,lon){
  if(!hospitals.length) return;
  hospitals.forEach(h=>{
    h.dist=distanceKm(lat,lon,h.lat,h.lon);
  });
  hospitals.sort((a,b)=>a.dist-b.dist);

  const list=document.getElementById("hospitalList");
  list.innerHTML=`<option value="">üè• Select nearest hospital</option>`;
  hospitals.slice(0,10).forEach(h=>{
    const o=document.createElement("option");
    o.value=`${h.lat},${h.lon}`;
    o.text=`${h.name}`;
    list.appendChild(o);
  });
}

/* Destination selection */
hospitalList.onchange=async e=>{
  if(!e.target.value) return;
  await supabaseClient.from("alerts").update({
    destination:e.target.value,
    destination_name:e.target.options[e.target.selectedIndex].text
  }).eq("id",1);
  msg.innerText="üè• Destination updated";
};

/* GPS */
function startTracking(){
  watchId=navigator.geolocation.watchPosition(async p=>{
    const loc=`${p.coords.latitude},${p.coords.longitude}`;
    location.value=loc;
    await supabaseClient.from("alerts")
      .update({location:loc}).eq("id",1);
    updateHospitalList(p.coords.latitude,p.coords.longitude);
    msg.innerText="üìç Tracking live location...";
  },()=>alert("GPS denied"),{enableHighAccuracy:true});
}

function stopTracking(){
  if(watchId){navigator.geolocation.clearWatch(watchId);}
  msg.innerText="‚õî Tracking stopped";
}

/* Emergency */
async function sendEmergency(){
  await supabaseClient.from("alerts")
    .update({emergency:true}).eq("id",1);
  msg.innerText="üö® Emergency alert sent";
}
async function cancelEmergency(){
  await supabaseClient.from("alerts")
    .update({emergency:false}).eq("id",1);
  msg.innerText="‚úÖ Emergency alert cancelled";
}
</script>
</body>
</html>

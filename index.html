<!DOCTYPE html>
<html>
<head>
  <title>üöë Smart Ambulance</title>
  <style>
    body {
      margin:0;
      font-family:Segoe UI;
      background:linear-gradient(135deg,#ff4d4d,#b30000);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .box{
      background:white;
      width:420px;
      padding:25px;
      border-radius:20px;
      box-shadow:0 15px 40px rgba(0,0,0,0.3);
      text-align:center;
    }
    select{
      width:100%;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>üöë Smart Ambulance</h2>
  <p id="status">Waiting for GPS...</p>

  <h4>üè• Nearby Hospitals (5km radius)</h4>
  <select id="hospitalDropdown"></select>
</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

let currentLat = 0;
let currentLng = 0;

/* Distance Formula */
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) *
    Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* Fetch Real Nearby Hospitals */
async function loadNearbyHospitals(lat, lng){

  const radius = 5000; // 5km

  const query = `
    [out:json];
    (
      node["amenity"="hospital"](around:${radius},${lat},${lng});
    );
    out;
  `;

  const response = await fetch(
    "https://overpass-api.de/api/interpreter",
    {
      method: "POST",
      body: query
    }
  );

  const data = await response.json();

  if(!data.elements) return;

  const hospitals = data.elements.map(h => ({
    name: h.tags.name || "Hospital",
    lat: h.lat,
    lng: h.lon,
    distance: calculateDistance(lat, lng, h.lat, h.lon)
  }));

  // Sort nearest first
  hospitals.sort((a,b)=> a.distance - b.distance);

  const dropdown = document.getElementById("hospitalDropdown");
  dropdown.innerHTML = "";

  hospitals.forEach(h => {
    const option = document.createElement("option");
    option.value = JSON.stringify({lat:h.lat, lng:h.lng});
    option.text = `${h.name} - ${h.distance.toFixed(2)} km`;
    dropdown.appendChild(option);
  });

}

/* GPS Tracking */
navigator.geolocation.watchPosition(async(pos)=>{

  currentLat = pos.coords.latitude;
  currentLng = pos.coords.longitude;

  document.getElementById("status").innerText =
    `üìç ${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}`;

  // Update live location
  await supabase.from("ambulance_location")
  .upsert(
    {ambulance_id:1, lat:currentLat, lng:currentLng},
    {onConflict:"ambulance_id"}
  );

  // Load nearby hospitals dynamically
  loadNearbyHospitals(currentLat, currentLng);

},
(error)=>{
  console.log("GPS Error:", error);
},
{ enableHighAccuracy:true }
);

/* Save Selected Destination */
document.getElementById("hospitalDropdown")
.addEventListener("change", async function(){

  const selected = JSON.parse(this.value);

  await supabase.from("ambulance_location")
  .update({
    dest_lat:selected.lat,
    dest_lng:selected.lng
  })
  .eq("ambulance_id",1);

});

</script>

</body>
</html>

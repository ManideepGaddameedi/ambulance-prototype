<!DOCTYPE html>
<html>
<head>
  <title>Smart Ambulance - Nearest Hospitals</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>ðŸš‘ Smart Ambulance Panel</h2>

<p id="location">Getting Location...</p>

<h3>Nearest Hospitals</h3>
<div id="hospitalList">Loading...</div>

<script>
const { createClient } = supabase;

const client = createClient(
  "https://inlkqessbewmxmtfvzfe.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlubGtxZXNzYmV3bXhtdGZ2emZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNjgxODYsImV4cCI6MjA4NDY0NDE4Nn0.5qiSgu3WlXJW4ARwwLC5XV6zvMwfGdH_xtUlu_qat0I"
);

let currentLat = 0;
let currentLng = 0;

/* 1ï¸âƒ£ Get Live GPS Location */
navigator.geolocation.getCurrentPosition(async (position) => {

  currentLat = position.coords.latitude;
  currentLng = position.coords.longitude;

  document.getElementById("location").innerText =
    "Your Location: " + currentLat + ", " + currentLng;

  loadHospitals();

}, error => {
  document.getElementById("location").innerText =
    "Location access denied!";
});


/* 2ï¸âƒ£ Load Hospitals */
async function loadHospitals() {

  const { data, error } = await client
    .from("hospitals")
    .select("*");

  if (error) {
    document.getElementById("hospitalList").innerText =
      "Error: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    document.getElementById("hospitalList").innerText =
      "No hospitals found in database.";
    return;
  }

  /* 3ï¸âƒ£ Calculate Distance */
  data.forEach(h => {
    h.distance = getDistance(
      currentLat,
      currentLng,
      h.latitude,
      h.longitude
    );
  });

  /* 4ï¸âƒ£ Sort Nearest First */
  data.sort((a, b) => a.distance - b.distance);

  displayHospitals(data);
}


/* 5ï¸âƒ£ Display Buttons */
function displayHospitals(hospitals) {

  let list = document.getElementById("hospitalList");
  list.innerHTML = "";

  hospitals.forEach(h => {

    let btn = document.createElement("button");

    btn.innerText =
      h.name +
      " - " + h.distance.toFixed(2) + " km" +
      " | Beds: " + h.beds_available +
      " | Doctor: " + (h.doctor_available ? "Yes" : "No");

    btn.style.marginBottom = "8px";
    btn.style.padding = "8px";

    btn.onclick = () => {
      alert("Selected: " + h.name);
    };

    list.appendChild(btn);
    list.appendChild(document.createElement("br"));
  });
}


/* Haversine Distance Formula */
function getDistance(lat1, lon1, lat2, lon2) {

  const R = 6371; // Earth radius in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) *
    Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c;
}

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>üöë Ambulance Panel</title>
  <style>
    body {
      margin:0;
      font-family:Segoe UI;
      background:linear-gradient(135deg,#ff4d4d,#b30000);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .box{
      background:white;
      width:420px;
      padding:25px;
      border-radius:20px;
      box-shadow:0 15px 40px rgba(0,0,0,0.3);
      text-align:center;
    }
    select{
      width:100%;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>üöë Smart Ambulance</h2>
  <p id="status">Waiting for GPS...</p>

  <h4>üè• Select Destination</h4>
  <select id="hospitalDropdown"></select>
</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

let currentLat = 0;
let currentLng = 0;

/* Load hospitals */
async function loadHospitals(){
  const { data } = await supabase.from("hospitals").select("*");
  const dropdown = document.getElementById("hospitalDropdown");
  dropdown.innerHTML="";
  data.forEach(h=>{
    const option=document.createElement("option");
    option.value=h.id;
    option.text=h.name;
    dropdown.appendChild(option);
  });
}
await loadHospitals();

/* GPS Tracking */
navigator.geolocation.watchPosition(async(pos)=>{

  currentLat = pos.coords.latitude;
  currentLng = pos.coords.longitude;

  document.getElementById("status").innerText =
    `üìç ${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}`;

  await supabase.from("ambulance_location")
  .upsert(
    {ambulance_id:1, lat:currentLat, lng:currentLng},
    {onConflict:"ambulance_id"}
  );

});

/* Set Destination */
document.getElementById("hospitalDropdown")
.addEventListener("change", async function(){

  const { data } = await supabase
    .from("hospitals")
    .select("*")
    .eq("id", this.value)
    .single();

  await supabase.from("ambulance_location")
  .update({
    dest_lat:data.lat,
    dest_lng:data.lng
  })
  .eq("ambulance_id",1);

});

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Ambulance Device</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:Arial;background:#f4f6f9}
    .box{max-width:420px;margin:40px auto;background:#fff;
      padding:20px;border-radius:10px;
      box-shadow:0 4px 10px rgba(0,0,0,.2);text-align:center}
    select,input,button{
      width:100%;padding:10px;margin-top:10px;font-size:16px}
    .emergency{background:red;color:#fff;font-weight:bold}
    .cancel{background:#444;color:#fff}
    .hint{font-size:13px;color:#555;margin-top:6px}
  </style>
</head>
<body>

<div class="box">
  <h2>üöë Ambulance Device</h2>

  <select id="hospitalList">
    <option value="">üè• Select nearest hospital</option>
  </select>
  <div class="hint">Hospitals are auto-sorted by nearest distance</div>

  <input id="location" placeholder="Live GPS location" readonly>

  <button onclick="startTracking()">‚ñ∂ START TRACKING</button>
  <button onclick="stopTracking()">‚õî STOP TRACKING</button>

  <button class="emergency" onclick="sendEmergency()">üö® EMERGENCY ALERT</button>
  <button class="cancel" onclick="cancelEmergency()">‚ùå CANCEL ALERT</button>

  <p id="msg"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = supabase.createClient(
  "https://inlkqessbewmxmtfvzfe.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlubGtxZXNzYmV3bXhtdGZ2emZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNjgxODYsImV4cCI6MjA4NDY0NDE4Nn0.5qiSgu3WlXJW4ARwwLC5XV6zvMwfGdH_xtUlu_qat0I"
);

let watchId=null;
let hospitals=[];

/* distance only for sorting */
function dist(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* load hospitals */
async function loadHospitals(){
  const q=`[out:json];
    node["amenity"="hospital"](14.399,79.941,14.470,80.021);
    out;`;
  const r=await fetch("https://overpass-api.de/api/interpreter",
    {method:"POST",body:q});
  const j=await r.json();
  hospitals=j.elements
    .filter(h=>h.tags&&h.tags.name)
    .map(h=>({name:h.tags.name,lat:h.lat,lon:h.lon}));
}
loadHospitals();

/* update dropdown */
function updateHospitals(lat,lon){
  if(!hospitals.length) return;
  hospitals.forEach(h=>h.d=dist(lat,lon,h.lat,h.lon));
  hospitals.sort((a,b)=>a.d-b.d);
  hospitalList.innerHTML=
    `<option value="">üè• Select nearest hospital</option>`;
  hospitals.slice(0,10).forEach(h=>{
    const o=document.createElement("option");
    o.value=`${h.lat},${h.lon}`;
    o.text=h.name;
    hospitalList.appendChild(o);
  });
}

/* destination change */
hospitalList.onchange=async e=>{
  if(!e.target.value) return;
  await supabaseClient.from("alerts").update({
    destination:e.target.value,
    destination_name:e.target.options[e.target.selectedIndex].text
  }).eq("id",1);
  msg.innerText="üè• Destination updated";
};

/* gps */
function startTracking(){
  if(!navigator.geolocation){
    alert("Geolocation not supported");return;
  }
  watchId=navigator.geolocation.watchPosition(async p=>{
    const loc=`${p.coords.latitude},${p.coords.longitude}`;
    location.value=loc;
    await supabaseClient.from("alerts")
      .update({location:loc}).eq("id",1);
    updateHospitals(p.coords.latitude,p.coords.longitude);
    msg.innerText="üìç Tracking live location...";
  },()=>alert("GPS denied"),{enableHighAccuracy:true});
}
function stopTracking(){
  if(watchId)navigator.geolocation.clearWatch(watchId);
  msg.innerText="‚õî Tracking stopped";
}

/* emergency */
async function sendEmergency(){
  await supabaseClient.from("alerts")
    .update({emergency:true}).eq("id",1);
  msg.innerText="üö® Emergency alert sent";
}
async function cancelEmergency(){
  await supabaseClient.from("alerts")
    .update({emergency:false}).eq("id",1);
  msg.innerText="‚úÖ Emergency alert cancelled";
}
</script>
</body>
</html>

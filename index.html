<!DOCTYPE html>
<html>
<head>
  <title>üöë Ambulance Panel</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ff4d4d, #b30000);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: white;
      width: 420px;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      text-align: center;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
    }
    button {
      background: red;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üöë Smart Ambulance</h2>
  <p id="status">Waiting for GPS...</p>

  <h4>üè• Select Destination</h4>
  <select id="hospitalDropdown"></select>
</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "YOUR_ANON_KEY"
);

let currentLat = 0;
let currentLng = 0;

/* Load Hospitals */
async function loadHospitals() {
  const { data } = await supabase.from("hospitals").select("*");
  const dropdown = document.getElementById("hospitalDropdown");
  dropdown.innerHTML = "";

  data.forEach(h => {
    const option = document.createElement("option");
    option.value = h.id;
    option.text = h.name;
    dropdown.appendChild(option);
  });
}
await loadHospitals();

/* GPS Tracking */
navigator.geolocation.watchPosition(async (pos) => {

  currentLat = pos.coords.latitude;
  currentLng = pos.coords.longitude;

  document.getElementById("status").innerText =
    `üìç ${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}`;

  await supabase
    .from("ambulance_location")
    .upsert(
      { ambulance_id: 1, lat: currentLat, lng: currentLng },
      { onConflict: "ambulance_id" }
    );

});

/* Select Hospital */
document.getElementById("hospitalDropdown")
.addEventListener("change", async function() {

  const hospitalId = this.value;

  const { data } = await supabase
    .from("hospitals")
    .select("*")
    .eq("id", hospitalId)
    .single();

  await supabase
    .from("ambulance_location")
    .update({
      dest_lat: data.lat,
      dest_lng: data.lng
    })
    .eq("ambulance_id", 1);

  alert("üè• Destination Set");

});

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Ambulance Panel</title>
</head>
<body>

<h2>ğŸš‘ Ambulance Dashboard</h2>

<button id="alertBtn">ğŸš¨ Send Emergency Alert</button>
<br><br>

<select id="hospitalDropdown">
  <option>Select Hospital</option>
</select>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

let currentLat = 17.3850;
let currentLng = 78.4867;

/* LOCATION UPDATE */
navigator.geolocation.watchPosition(async (pos) => {
  currentLat = pos.coords.latitude;
  currentLng = pos.coords.longitude;

  await supabase
    .from("ambulance_location")
    .update({ lat: currentLat, lng: currentLng })
    .eq("ambulance_id", 1);

});

/* SEND ALERT */
document.getElementById("alertBtn").addEventListener("click", async () => {

  const { error } = await supabase
    .from("emergency_alerts")
    .insert([{
      ambulance_id: 1,
      latitude: currentLat,
      longitude: currentLng
    }]);

  if(error){
    alert("Error sending alert");
    console.log(error);
    return;
  }

  alert("ğŸš¨ Alert Sent to Police");

  loadHospitals();
});

/* LOAD HOSPITALS */
async function loadHospitals(){

  const { data, error } = await supabase
    .from("hospitals")
    .select("*");

  if(error){
    console.log(error);
    return;
  }

  const dropdown = document.getElementById("hospitalDropdown");
  dropdown.innerHTML = "";

  data.forEach(h => {

    let distance = Math.sqrt(
      Math.pow(currentLat - h.lat, 2) +
      Math.pow(currentLng - h.lng, 2)
    ) * 111;

    let eta = (distance / 40) * 60;

    const option = document.createElement("option");
    option.value = h.id;
    option.textContent =
      `${h.name} - ${distance.toFixed(2)} km - ETA ${eta.toFixed(0)} mins`;

    dropdown.appendChild(option);
  });

}

/* SELECT HOSPITAL */
document.getElementById("hospitalDropdown")
.addEventListener("change", async (e) => {

  const hospitalId = e.target.value;
  if(!hospitalId) return;

  await supabase
    .from("emergency_alerts")
    .update({ hospital_id: hospitalId })
    .eq("status", "ACTIVE");

  alert("ğŸ¥ Hospital Assigned");

});

</script>
</body>
</html>

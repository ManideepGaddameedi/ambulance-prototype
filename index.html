<!DOCTYPE html>
<html>
<head>
  <title>üöë Ambulance Panel</title>
  <style>
    body {
      margin:0;
      font-family:Segoe UI;
      background:linear-gradient(135deg,#ff4d4d,#b30000);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .box{
      background:white;
      width:420px;
      padding:25px;
      border-radius:20px;
      box-shadow:0 15px 40px rgba(0,0,0,0.3);
      text-align:center;
    }
    select{
      width:100%;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>üöë Smart Ambulance</h2>
  <p id="status">Waiting for GPS...</p>

  <h4>üè• Nearest Hospitals</h4>
  <select id="hospitalDropdown"></select>
</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

let currentLat = 0;
let currentLng = 0;

/* Haversine Distance Formula */
function calculateDistance(lat1, lon1, lat2, lon2){

  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) *
    Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c;
}

/* Load & Sort Hospitals */
async function loadHospitals(lat, lng){

  const { data, error } = await supabase
    .from("hospitals")
    .select("*");

  if(error){
    console.log("Hospital fetch error:", error);
    return;
  }

  if(!data) return;

  // Add distance
  const withDistance = data.map(h => ({
    ...h,
    distance: calculateDistance(lat, lng, h.lat, h.lng)
  }));

  // Sort nearest first
  withDistance.sort((a,b) => a.distance - b.distance);

  const dropdown = document.getElementById("hospitalDropdown");
  dropdown.innerHTML = "";

  withDistance.forEach(h => {
    const option = document.createElement("option");
    option.value = h.id;
    option.text =
      `${h.name} - ${h.distance.toFixed(2)} km`;
    dropdown.appendChild(option);
  });
}

/* GPS Tracking */
navigator.geolocation.watchPosition(async(pos)=>{

  currentLat = pos.coords.latitude;
  currentLng = pos.coords.longitude;

  document.getElementById("status").innerText =
    `üìç ${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}`;

  // Update live location in database
  await supabase.from("ambulance_location")
  .upsert(
    {ambulance_id:1, lat:currentLat, lng:currentLng},
    {onConflict:"ambulance_id"}
  );

  // üî• Update nearest hospitals dynamically
  loadHospitals(currentLat, currentLng);

},
(error)=>{
  console.log("GPS error:", error);
},
{ enableHighAccuracy:true }
);

/* Save selected destination */
document.getElementById("hospitalDropdown")
.addEventListener("change", async function(){

  const hospitalId = this.value;

  const { data } = await supabase
    .from("hospitals")
    .select("*")
    .eq("id", hospitalId)
    .single();

  if(!data) return;

  await supabase.from("ambulance_location")
  .update({
    dest_lat:data.lat,
    dest_lng:data.lng
  })
  .eq("ambulance_id",1);

});

</script>
</body>
</html>

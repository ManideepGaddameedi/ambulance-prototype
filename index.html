<!DOCTYPE html>
<html>
<head>
  <title>Ambulance Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

<h2>ðŸš‘ Ambulance Dashboard</h2>

<button onclick="sendAlert()" style="background:red;color:white;padding:10px;">
ðŸš¨ SEND EMERGENCY ALERT
</button>

<br><br>

<select id="hospitalDropdown" onchange="selectHospital(this.value)">
<option>Select Hospital</option>
</select>

<script>

const supabase = window.supabase.createClient(
  "YOUR_SUPABASE_URL",
  "YOUR_ANON_KEY"
);

let currentLat = 0;
let currentLng = 0;

navigator.geolocation.watchPosition(async (pos)=>{

  currentLat = pos.coords.latitude;
  currentLng = pos.coords.longitude;

  await supabase
  .from("ambulance_location")
  .update({ lat: currentLat, lng: currentLng })
  .eq("ambulance_id", 1);

});

async function sendAlert(){

  await supabase.from("emergency_alerts").insert([{
    ambulance_id:1,
    latitude: currentLat,
    longitude: currentLng
  }]);

  loadHospitals();
}

async function loadHospitals(){

  const { data } = await supabase.from("hospitals").select("*");

  const dropdown = document.getElementById("hospitalDropdown");
  dropdown.innerHTML = "";

  data.forEach(h => {

    let distance = Math.sqrt(
      Math.pow(currentLat - h.lat,2) +
      Math.pow(currentLng - h.lng,2)
    ) * 111;

    let eta = (distance / 40) * 60;

    let option = document.createElement("option");
    option.value = h.id;
    option.text = `${h.name} - ${distance.toFixed(2)} km - ETA ${eta.toFixed(0)} mins`;

    dropdown.appendChild(option);
  });
}

async function selectHospital(id){

  await supabase
  .from("emergency_alerts")
  .update({ hospital_id:id })
  .eq("status","ACTIVE");

  alert("Hospital Selected & Alert Sent");
}

</script>
</body>
</html>

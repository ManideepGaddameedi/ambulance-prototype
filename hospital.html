<!DOCTYPE html>
<html>
<head>
  <title>ğŸ¥ Hospital Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial; }
    #map { height: 500px; margin-top: 10px; }
    .panel { margin-top: 15px; }
  </style>
</head>
<body>

<h2>ğŸ¥ Hospital Live Ambulance Tracking</h2>
<div id="map"></div>

<div class="panel">
  <h3>Update Availability</h3>
  Beds: <input type="number" id="beds"><br><br>
  Doctors: <input type="number" id="doctors"><br><br>
  <button id="updateBtn">Update Availability</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* -------- SUPABASE INIT -------- */

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

/* -------- MAP INIT -------- */

const map = L.map('map').setView([17.3850, 78.4867], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

/* -------- CUSTOM AMBULANCE ICON -------- */

const ambulanceIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

/* -------- CREATE MARKER -------- */

let ambulanceMarker = L.marker([17.3850, 78.4867], {
  icon: ambulanceIcon
}).addTo(map);

let previousLatLng = [17.3850, 78.4867];

/* -------- SMOOTH MOVE FUNCTION -------- */

function smoothMove(newLat, newLng) {

  const steps = 25;
  const delay = 20;

  let latStep = (newLat - previousLatLng[0]) / steps;
  let lngStep = (newLng - previousLatLng[1]) / steps;

  let i = 0;

  const interval = setInterval(() => {

    if (i >= steps) {
      clearInterval(interval);
      previousLatLng = [newLat, newLng];
      return;
    }

    previousLatLng[0] += latStep;
    previousLatLng[1] += lngStep;

    ambulanceMarker.setLatLng(previousLatLng);

    i++;

  }, delay);
}

/* -------- LOAD INITIAL LOCATION -------- */

async function loadInitialLocation() {

  const { data, error } = await supabase
    .from("ambulance_location")
    .select("*")
    .eq("ambulance_id", 1)
    .single();

  if (error) {
    console.log("Initial Fetch Error:", error);
    return;
  }

  if (data) {
    previousLatLng = [data.lat, data.lng];
    ambulanceMarker.setLatLng([data.lat, data.lng]);
    map.setView([data.lat, data.lng], 15);
  }
}

await loadInitialLocation();

/* -------- REALTIME SUBSCRIPTION -------- */

const channel = supabase.channel("hospital-ambulance-tracking");

channel
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "ambulance_location"
    },
    (payload) => {

      if (!payload.new) return;

      const lat = payload.new.lat;
      const lng = payload.new.lng;

      smoothMove(lat, lng);
      map.panTo([lat, lng]);

    }
  )
  .subscribe((status) => {
    console.log("Realtime Status:", status);
  });

/* -------- UPDATE AVAILABILITY -------- */

document.getElementById("updateBtn")
.addEventListener("click", async () => {

  const beds = document.getElementById("beds").value;
  const doctors = document.getElementById("doctors").value;

  await supabase
    .from("hospitals")
    .update({
      available_beds: beds,
      available_doctors: doctors
    })
    .eq("id", 1);

  alert("Availability Updated");

});

/* -------- CLEANUP -------- */

window.addEventListener("beforeunload", () => {
  supabase.removeChannel(channel);
});

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>ðŸ‘® Police Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial; }
    #map { height: 500px; margin-top: 10px; }
  </style>
</head>
<body>

<h2>ðŸ‘® Police Live Ambulance Tracking</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* -------- SUPABASE INIT -------- */

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

/* -------- MAP INIT -------- */

const map = L.map('map').setView([17.3850, 78.4867], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let ambulanceMarker = L.marker([17.3850, 78.4867])
  .addTo(map)
  .bindPopup("ðŸš‘ Ambulance");

/* -------- LOAD INITIAL LOCATION -------- */

async function loadInitialLocation() {

  const { data, error } = await supabase
    .from("ambulance_location")
    .select("*")
    .eq("ambulance_id", 1)
    .single();

  if (error) {
    console.log("Initial Fetch Error:", error);
    return;
  }

  if (data) {
    ambulanceMarker.setLatLng([data.lat, data.lng]);
    map.setView([data.lat, data.lng], 15);
  }
}

await loadInitialLocation();

/* -------- REALTIME SUBSCRIPTION -------- */

const channel = supabase.channel("ambulance-tracking");

channel
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "ambulance_location"
    },
    (payload) => {

      console.log("Realtime Payload:", payload);

      if (!payload.new) return;

      const lat = payload.new.lat;
      const lng = payload.new.lng;

      ambulanceMarker.setLatLng([lat, lng]);
      map.setView([lat, lng], 15);
    }
  )
  .subscribe((status) => {
    console.log("Realtime Status:", status);
  });

/* -------- CLEANUP (PREVENT CHANNEL ERROR LOOP) -------- */

window.addEventListener("beforeunload", () => {
  supabase.removeChannel(channel);
});

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Traffic Police Dashboard</title>
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

<h2>üö¶ Traffic Police Control</h2>

<p><b>Distance:</b> <span id="dist">--</span> km</p>
<p><b>ETA:</b> <span id="eta">--</span> mins</p>
<p><b>Intersections:</b> <span id="ints">--</span></p>

<div id="map" style="height:400px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseClient = supabase.createClient(
  "https://YOUR_PROJECT.supabase.co",
  "YOUR_ANON_KEY"
);

/* üè• FIXED HOSPITAL LOCATION (DEMO) */
const HOSPITAL = [17.3850, 78.4867]; // Example: Hyderabad hospital

/* üó∫ MAP */
const map = L.map("map").setView(HOSPITAL, 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

L.marker(HOSPITAL).addTo(map).bindPopup("Hospital");

let ambMarker = null;
let routeLine = null;

/* üåç DISTANCE FORMULA */
function distanceKm(a, b) {
  const R = 6371;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLng = (b[1]-a[1]) * Math.PI/180;
  const x =
    Math.sin(dLat/2)**2 +
    Math.cos(a[0]*Math.PI/180) *
    Math.cos(b[0]*Math.PI/180) *
    Math.sin(dLng/2)**2;
  return (R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x)));
}

/* üîÑ UPDATE LOOP */
async function update() {
  const { data } = await supabaseClient
    .from("alerts")
    .select("*")
    .eq("id",1)
    .single();

  if (!data || !data.location) return;

  const [lat, lng] = data.location.split(",").map(Number);
  const ambPos = [lat, lng];

  /* Marker */
  if (!ambMarker) {
    ambMarker = L.marker(ambPos).addTo(map);
  } else {
    ambMarker.setLatLng(ambPos);
  }

  /* Route (STRAIGHT LINE) */
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline([ambPos, HOSPITAL], {
    color: "blue",
    dashArray: "6,4"
  }).addTo(map);

  /* Distance + ETA */
  const dist = distanceKm(ambPos, HOSPITAL);
  const avgSpeed = 40; // km/h (assumed ambulance speed)
  const eta = (dist / avgSpeed) * 60;

  document.getElementById("dist").innerText = dist.toFixed(2);
  document.getElementById("eta").innerText = eta.toFixed(1);

  /* Intersections (SIMULATED) */
  document.getElementById("ints").innerText =
    Math.max(1, Math.floor(dist * 2));
}

setInterval(update, 3000);
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>ðŸ‘® Police Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>#map{height:500px}</style>
</head>
<body>

<h2>ðŸ‘® Live Ambulance Tracking</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

const map = L.map('map').setView([17.3850,78.4867],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marker = L.marker([17.3850,78.4867]).addTo(map);

/* Load initial location */
async function loadInitial(){
  const { data } = await supabase
    .from("ambulance_location")
    .select("*")
    .eq("ambulance_id",1)
    .single();

  if(data){
    marker.setLatLng([data.lat,data.lng]);
    map.setView([data.lat,data.lng],15);
  }
}
await loadInitial();

/* Realtime */
supabase
.channel("ambulance-live")
.on(
  "postgres_changes",
  {
    event:"UPDATE",
    schema:"public",
    table:"ambulance_location"
  },
  (payload)=>{

    if(payload.new.ambulance_id !== 1) return;

    marker.setLatLng([payload.new.lat,payload.new.lng]);
    map.panTo([payload.new.lat,payload.new.lng]);
  }
)
.subscribe();

</script>
</body>
</html>

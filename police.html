<!DOCTYPE html>
<html>
<head>
  <title>ðŸ‘® Police Control Center</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
    }

    .header {
      padding: 20px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      background: rgba(0,0,0,0.3);
    }

    .map-container {
      padding: 20px;
    }

    #map {
      height: 500px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .status {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #00ffcc;
    }
  </style>
</head>
<body>

<div class="header">ðŸ‘® Police Emergency Monitoring System</div>

<div class="map-container">
  <div id="map"></div>
  <div class="status">ðŸš‘ Live Ambulance Tracking Active</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

const map = L.map('map').setView([17.3850, 78.4867], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

const ambulanceIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

let ambulanceMarker = L.marker([17.3850, 78.4867], { icon: ambulanceIcon }).addTo(map);
let previousLatLng = [17.3850, 78.4867];

function smoothMove(newLat, newLng) {
  const steps = 25;
  const delay = 20;
  let latStep = (newLat - previousLatLng[0]) / steps;
  let lngStep = (newLng - previousLatLng[1]) / steps;
  let i = 0;

  const interval = setInterval(() => {
    if (i >= steps) {
      clearInterval(interval);
      previousLatLng = [newLat, newLng];
      return;
    }
    previousLatLng[0] += latStep;
    previousLatLng[1] += lngStep;
    ambulanceMarker.setLatLng(previousLatLng);
    i++;
  }, delay);
}

async function loadInitialLocation() {
  const { data } = await supabase
    .from("ambulance_location")
    .select("*")
    .eq("ambulance_id", 1)
    .single();

  if (data) {
    previousLatLng = [data.lat, data.lng];
    ambulanceMarker.setLatLng([data.lat, data.lng]);
    map.setView([data.lat, data.lng], 15);
  }
}

await loadInitialLocation();

const channel = supabase.channel("police-track");

channel
  .on("postgres_changes",
    { event: "*", schema: "public", table: "ambulance_location" },
    (payload) => {
      if (!payload.new) return;
      smoothMove(payload.new.lat, payload.new.lng);
      map.panTo([payload.new.lat, payload.new.lng]);
    }
  )
  .subscribe();

window.addEventListener("beforeunload", () => {
  supabase.removeChannel(channel);
});

</script>
</body>
</html>

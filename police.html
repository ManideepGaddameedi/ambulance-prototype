<!DOCTYPE html>
<html>
<head>
  <title>ðŸ‘® Police Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>#map{height:500px}</style>
</head>
<body>

<h2>ðŸ‘® Live Tracking</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://cfmxqwaopfahthflqgih.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbXhxd2FvcGZhaHRoZmxxZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjg4NjEsImV4cCI6MjA4NzY0NDg2MX0.38jNHf-7UGhIelL87oWxB5eK0e5ZivfGSsyEv1C9pL0"
);

const map=L.map('map').setView([17.3850,78.4867],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const ambulanceIcon=L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
  iconSize:[40,40],
  iconAnchor:[20,20]
});

let marker=L.marker([17.3850,78.4867],{icon:ambulanceIcon}).addTo(map);
let routeLine=null;
let info=L.control({position:'bottomleft'});

info.onAdd=function(){
  this._div=L.DomUtil.create('div');
  this._div.style.background="white";
  this._div.style.padding="8px";
  this._div.style.borderRadius="8px";
  return this._div;
};
info.addTo(map);

/* Draw Route */
async function drawRoute(startLat,startLng,destLat,destLng){

  const res=await fetch(
  `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${destLng},${destLat}?overview=full&geometries=geojson`
  );

  const data=await res.json();
  if(!data.routes) return;

  const route=data.routes[0];

  if(routeLine) map.removeLayer(routeLine);

  routeLine=L.geoJSON(route.geometry,{color:"red"}).addTo(map);

  info._div.innerHTML=
    `<b>Distance:</b> ${(route.distance/1000).toFixed(2)} km<br>
     <b>ETA:</b> ${(route.duration/60).toFixed(0)} mins`;
}

/* Realtime */
supabase.channel("live-track")
.on(
  "postgres_changes",
  {event:"UPDATE",schema:"public",table:"ambulance_location"},
  (payload)=>{

    const {lat,lng,dest_lat,dest_lng}=payload.new;

    marker.setLatLng([lat,lng]);
    map.panTo([lat,lng]);

    if(dest_lat && dest_lng){
      drawRoute(lat,lng,dest_lat,dest_lng);
    }
  }
)
.subscribe();

</script>
</body>
</html>
